 <!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Treino Avan√ßado com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: 'var(--color-primary, #FFA500)',
                            hover: 'var(--color-primary-hover, #FFC14D)',
                        },
                        secondary: {
                            DEFAULT: 'var(--color-secondary, #FFD700)',
                        },
                        gemini: {
                            DEFAULT: '#4285F4',
                            hover: '#63a0ff',
                        },
                        dark: {
                            100: '#121212',
                            200: '#1e1e1e',
                            300: '#2a2a2a',
                            400: '#3a3a3a'
                        },
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        :root {
            --color-primary: #FFA500;
            --color-primary-hover: #FFC14D;
            --color-secondary: #FFD700;
        }
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .tab-active { border-bottom: 2px solid var(--color-primary); color: var(--color-primary); }
        .card-hover:hover { transform: translateY(-3px); transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .loading-spinner { border: 3px solid #4a4a4a; border-top: 3px solid var(--color-primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pr-badge { animation: pulse-badge 1.5s infinite; }
        @keyframes pulse-badge { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body class="bg-dark-100 text-gray-200 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-dark-100 bg-opacity-90 flex flex-col items-center justify-center z-[100]">
        <div class="loading-spinner !w-16 !h-16 !border-4"></div>
        <p class="mt-4 text-lg text-gray-300">A carregar os seus dados...</p>
    </div>

    <!-- Header -->
    <header class="bg-dark-200 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14 4.14 5.57 2 7.71 3.43 9.14 2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 16.29 22 17.71 20.57 19.14 22 20.57 20.57 22 19.14 20.57 17.71 22 16.29 20.57 14.86z"/></svg>
                    </div>
                    <h1 class="text-2xl font-bold text-primary">FitTrack Pro</h1>
                </div>
                <div class="flex items-center space-x-1 bg-dark-300 rounded-lg p-1">
                    <button onclick="UI.switchTab('treino')" id="tab-treino" class="tab-button px-4 py-2 rounded-md transition-all duration-300">Treino</button>
                    <button onclick="UI.switchTab('dieta')" id="tab-dieta" class="tab-button px-4 py-2 rounded-md transition-all duration-300">Dieta</button>
                    <button onclick="UI.switchTab('corpo')" id="tab-corpo" class="tab-button px-4 py-2 rounded-md transition-all duration-300">Corpo</button>
                    <button onclick="UI.switchTab('progresso')" id="tab-progresso" class="tab-button px-4 py-2 rounded-md transition-all duration-300">Progresso</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Aba Treino -->
        <div id="content-treino" class="tab-content">
            <div class="bg-dark-200 rounded-lg p-4 mb-6 text-center">
                 <button onclick="AICoach.openModal('generate-plan')" class="w-full bg-gemini hover:bg-gemini-hover text-white font-bold py-3 rounded-lg mb-4 transition-colors">
                    ‚ú® Gerar Novo Plano de Treino com IA
                </button>
                <h3 class="text-lg font-bold text-primary mb-3">‚è±Ô∏è Cron√≥metro da Sess√£o</h3>
                <div id="session-timer" class="text-4xl font-bold text-secondary mb-4 timer-display">00:00:00</div>
                <div class="flex justify-center space-x-4">
                    <button onclick="sessionTimer.start()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">‚ñ∂Ô∏è Iniciar</button>
                    <button onclick="sessionTimer.pause()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">‚è∏Ô∏è Pausar</button>
                    <button onclick="sessionTimer.reset()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">üîÑ Resetar</button>
                </div>
            </div>
            
            <div id="workout-plan-container" class="space-y-4">
                <!-- O plano de treino ser√° renderizado aqui pelo JavaScript -->
            </div>
        </div>

        <!-- Aba Dieta -->
        <div id="content-dieta" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6 text-center text-primary">ü•ó Plano Alimentar</h2>
            <div class="bg-dark-200 rounded-lg p-4 mb-6 text-center space-y-4">
                 <button onclick="AICoach.openModal('generate-diet')" class="w-full bg-gemini hover:bg-gemini-hover text-white font-bold py-3 rounded-lg transition-colors">
                    ‚ú® Gerar Novo Plano Alimentar com IA
                </button>
                 <button onclick="AICoach.openModal('analyze-meal')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                    ü•ó Analisar Refei√ß√£o Individual
                </button>
            </div>
            <div id="diet-plan-container" class="space-y-4">
                 <!-- O plano de dieta ser√° renderizado aqui -->
            </div>
        </div>

        <!-- Aba Corpo -->
        <div id="content-corpo" class="tab-content hidden">
             <h2 class="text-3xl font-bold mb-6 text-center text-primary">üèÉ Progresso Corporal</h2>
             <div class="bg-dark-200 rounded-lg p-6 card-hover">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <div>
                        <label for="weight-input" class="block text-sm font-medium text-gray-400 mb-1">Peso Atual (kg)</label>
                        <input type="number" id="weight-input" class="w-full bg-dark-300 text-white rounded-lg p-2 border-2 border-dark-400 focus:border-primary outline-none" placeholder="Ex: 75.5">
                    </div>
                     <button onclick="Workout.saveWeight()" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-2 rounded-lg">üíæ Guardar Peso</button>
                </div>
             </div>
        </div>

        <!-- Aba Progresso -->
        <div id="content-progresso" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6 text-center text-primary">üìà O seu Progresso</h2>
            <div class="bg-dark-200 rounded-lg p-4 mb-6 text-center">
                 <button onclick="AICoach.openModal('weekly-summary')" class="w-full bg-gemini hover:bg-gemini-hover text-white font-bold py-3 rounded-lg transition-colors">
                    ‚ú® Gerar Resumo da Semana com IA
                </button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-dark-200 p-4 rounded-lg card-hover">
                    <h3 class="text-xl font-bold text-secondary mb-4">‚öñÔ∏è Hist√≥rico de Peso</h3>
                    <canvas id="weight-chart"></canvas>
                </div>
                <div class="bg-dark-200 p-4 rounded-lg card-hover">
                    <h3 class="text-xl font-bold text-secondary mb-4">üèãÔ∏è‚Äç‚ôÇÔ∏è Volume de Treino (Total)</h3>
                    <canvas id="volume-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="welcome-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-dark-200 rounded-lg p-6 max-w-lg w-full mx-4 text-center">
            <h2 class="text-2xl font-bold text-primary mb-4">Bem-vindo(a) ao FitTrack Pro!</h2>
            <p class="text-gray-300 mb-6">O seu progresso ser√° guardado automaticamente. O seu ID de utilizador √©: <br><strong id="user-id-display" class="text-secondary text-sm break-all"></strong></p>
            <button onclick="UI.closeModal('welcome-modal')" class="bg-primary hover:bg-primary-hover text-black font-semibold px-6 py-2 rounded-lg transition-colors">Come√ßar!</button>
        </div>
    </div>

    <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-dark-200 rounded-lg p-6 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="gemini-modal-title" class="text-xl font-bold text-gemini"></h3>
                <button onclick="UI.closeModal('gemini-modal')" class="text-gray-400 hover:text-white text-2xl">√ó</button>
            </div>
            <div id="gemini-modal-content"></div>
            <div id="gemini-modal-response" class="mt-4 p-4 bg-dark-300 rounded-lg max-h-64 overflow-y-auto hidden">
                 <div id="gemini-response-text" class="text-gray-300 whitespace-pre-wrap"></div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="gemini-modal-action-btn" class="bg-gemini hover:bg-gemini-hover text-white font-semibold px-6 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <span id="gemini-btn-text">Processar</span>
                    <div id="gemini-btn-loading" class="loading-spinner !border-t-white hidden"></div>
                </button>
            </div>
        </div>
    </div>
    
    <div id="notification-container" class="fixed bottom-5 right-5 z-[99] space-y-3"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const AppState = { user: null, db: null, auth: null, appId: null, userData: null, unsubscribe: null, charts: { weightChart: null, volumeChart: null } };

        const Data = {
            async init() {
                try {
                    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                    const firebaseConfig = JSON.parse(firebaseConfigString);
                    AppState.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    if (!firebaseConfig.apiKey) {
                        UI.showNotification("Configura√ß√£o do Firebase inv√°lida.", "error");
                        UI.hideLoading();
                        return;
                    }

                    const app = initializeApp(firebaseConfig);
                    AppState.auth = getAuth(app);
                    AppState.db = getFirestore(app);
                    this.handleAuthentication();
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    UI.showNotification("Erro ao conectar com o servidor.", "error");
                }
            },
            handleAuthentication() {
                onAuthStateChanged(AppState.auth, async (user) => {
                    if (user) {
                        AppState.user = user;
                        document.getElementById('user-id-display').textContent = user.uid;
                        this.loadUserData();
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(AppState.auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(AppState.auth);
                            }
                        } catch (error) {
                            console.error("Authentication Error:", error);
                        }
                    }
                });
            },
            async loadUserData() {
                if (!AppState.user || !AppState.appId) return;
                const userDocRef = doc(AppState.db, "artifacts", AppState.appId, "users", AppState.user.uid);
                if (AppState.unsubscribe) AppState.unsubscribe();
                AppState.unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        AppState.userData = docSnap.data();
                    } else {
                        this.createInitialUserData(userDocRef);
                    }
                    UI.render();
                    UI.hideLoading();
                });
            },
            async createInitialUserData(userDocRef) {
                const initialData = {
                    createdAt: new Date().toISOString(),
                    workoutPlan: this.getInitialWorkoutPlan(),
                    dietPlan: this.getInitialDietPlan(),
                    progressHistory: { weight: [], volume: [] },
                    personalRecords: {}
                };
                await setDoc(userDocRef, initialData);
                AppState.userData = initialData;
                UI.render();
                UI.showModal('welcome-modal');
            },
            async saveData() {
                if (!AppState.user || !AppState.appId) return;
                const userDocRef = doc(AppState.db, "artifacts", AppState.appId, "users", AppState.user.uid);
                await setDoc(userDocRef, AppState.userData, { merge: true });
            },
            getInitialWorkoutPlan() {
                const createLogs = (count) => Array.from({ length: count }, () => ({ w: 0, r: 0 }));
                return [
                    { id: 'A', name: 'Upper A', focus: 'Peito, Ombros, Tr√≠ceps', exercises: [
                        { id: 'ex1', name: 'Supino Reto', sets: 4, reps: '6-10', done: false, log: createLogs(4) },
                        { id: 'ex2', name: 'Desenvolvimento c/ Halteres', sets: 4, reps: '8-12', done: false, log: createLogs(4) },
                        { id: 'ex3', name: 'Tr√≠ceps Testa', sets: 3, reps: '10-15', done: false, log: createLogs(3) },
                    ]},
                    { id: 'B', name: 'Lower A', focus: 'Quadr√≠ceps, Gl√∫teos', exercises: [
                        { id: 'ex4', name: 'Agachamento Livre', sets: 4, reps: '6-10', done: false, log: createLogs(4) },
                        { id: 'ex5', name: 'Leg Press 45', sets: 4, reps: '8-12', done: false, log: createLogs(4) },
                        { id: 'ex6', name: 'Cadeira Extensora', sets: 3, reps: '12-15', done: false, log: createLogs(3) },
                    ]},
                    { id: 'C', name: 'Descanso Ativo', focus: 'Core e Cardio Leve', exercises: [
                        { id: 'ex7', name: 'Prancha', sets: 3, reps: '60s', done: false, log: createLogs(3) },
                        { id: 'ex8', name: 'Eleva√ß√£o de Pernas', sets: 3, reps: '15-20', done: false, log: createLogs(3) },
                    ]},
                    { id: 'D', name: 'Upper B', focus: 'Costas, B√≠ceps', exercises: [
                        { id: 'ex9', name: 'Remada Curvada', sets: 4, reps: '6-10', done: false, log: createLogs(4) },
                        { id: 'ex10', name: 'Puxada Frontal', sets: 4, reps: '8-12', done: false, log: createLogs(4) },
                        { id: 'ex11', name: 'Rosca Direta', sets: 3, reps: '10-12', done: false, log: createLogs(3) },
                    ]},
                    { id: 'E', name: 'Lower B', focus: 'Posterior, Gl√∫teos', exercises: [
                        { id: 'ex12', name: 'Levantamento Terra Romeno', sets: 4, reps: '8-12', done: false, log: createLogs(4) },
                        { id: 'ex13', name: 'Mesa Flexora', sets: 4, reps: '10-15', done: false, log: createLogs(4) },
                        { id: 'ex14', name: 'Eleva√ß√£o P√©lvica', sets: 3, reps: '12-15', done: false, log: createLogs(3) },
                    ]},
                ];
            },
            getInitialDietPlan() {
                return [
                    { id: 'meal1', name: 'Pequeno-Almo√ßo', time: '08:00', items: ['Ovos mexidos com espinafres', '1 fatia de p√£o integral', '1/2 Abacate'] },
                    { id: 'meal2', name: 'Lanche da Manh√£', time: '11:00', items: ['Iogurte Grego', 'Punhado de am√™ndoas'] },
                    { id: 'meal3', name: 'Almo√ßo', time: '13:30', items: ['150g Peito de Frango Grelhado', '100g Batata Doce', 'Salada mista com azeite'] },
                    { id: 'meal4', name: 'Lanche da Tarde', time: '16:30', items: ['1 Ma√ß√£', 'Pasta de Amendoim'] },
                    { id: 'meal5', name: 'Jantar', time: '20:00', items: ['150g Salm√£o Grelhado', 'Br√≥colos cozidos a vapor'] },
                ];
            }
        };

        const UI = {
            render() {
                if (!AppState.userData) return;
                this.renderWorkoutPlan();
                this.renderDietPlan();
                this.renderCharts();
                this.switchTab('treino');
            },
            renderWorkoutPlan() {
                const container = document.getElementById('workout-plan-container');
                if (!container || !AppState.userData.workoutPlan) return;
                container.innerHTML = AppState.userData.workoutPlan.map(day => this.createDayCardHTML(day)).join('');
                this.attachWorkoutEventListeners();
            },
             renderDietPlan() {
                const container = document.getElementById('diet-plan-container');
                if (!container || !AppState.userData.dietPlan) return;
                container.innerHTML = AppState.userData.dietPlan.map(meal => `
                    <div class="bg-dark-200 rounded-lg p-4 card-hover">
                        <h3 class="text-lg font-bold text-primary">${meal.name} <span class="text-sm text-gray-400 font-normal">- ${meal.time}</span></h3>
                        <ul class="list-disc list-inside mt-2 text-gray-300">
                            ${meal.items.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `).join('');
            },
            createDayCardHTML(day) {
                const isToday = this.getSuggestedWorkoutId() === day.id;
                return `<div id="day-card-${day.id}" class="bg-dark-200 rounded-lg overflow-hidden card-hover ${isToday ? 'border-2 border-primary' : ''}">
                        <button onclick="UI.toggleAccordion('day-${day.id}')" class="w-full p-4 text-left flex justify-between items-center hover:bg-dark-300 transition-colors">
                            <div><h3 class="text-xl font-bold text-primary">üí™ Dia ${day.id} ‚Äî ${day.name}</h3><p class="text-gray-400">${day.focus}</p></div>
                            <span id="arrow-day-${day.id}" class="text-2xl transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="content-day-${day.id}" class="accordion-content">
                            <div class="p-4 border-t border-dark-400 space-y-4">
                                ${day.exercises.map(ex => this.createExerciseHTML(ex, day.id)).join('')}
                                <button onclick="Workout.finishWorkout('${day.id}')" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Finalizar Treino</button>
                            </div></div></div>`;
            },
            createExerciseHTML(exercise, dayId) {
                const pr = AppState.userData.personalRecords[exercise.id];
                return `<div class="bg-dark-300 p-3 rounded-lg" data-day-id="${dayId}" data-exercise-id="${exercise.id}">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" class="form-checkbox h-5 w-5 bg-dark-400 border-gray-500 text-primary focus:ring-primary" ${exercise.done ? 'checked' : ''}>
                                <span class="font-semibold">${exercise.name} (${exercise.sets}x${exercise.reps})</span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${pr ? `<span class="pr-badge text-yellow-400 text-xs font-bold">üèÜ PR: ${pr.w}kg x ${pr.r} reps</span>` : ''}
                                <button onclick="AICoach.openModal('substitute', '${exercise.name}')" class="text-xs bg-blue-600 hover:bg-blue-700 p-1 rounded" title="Substituir Exerc√≠cio">üîÑ</button>
                                <button onclick="AICoach.openModal('technique', '${exercise.name}')" class="text-xs bg-purple-600 hover:bg-purple-700 p-1 rounded" title="Dicas de T√©cnica">üí°</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center text-sm"><span class="text-gray-400">S√©rie</span><span class="text-gray-400">Peso (kg)</span><span class="text-gray-400">Reps</span></div>
                        ${exercise.log.map((log, index) => `<div class="grid grid-cols-3 gap-2 items-center mt-2">
                                <span class="text-center font-medium">${index + 1}</span>
                                <input type="number" value="${log.w}" class="w-full bg-dark-400 rounded p-1 text-center" placeholder="kg">
                                <input type="number" value="${log.r}" class="w-full bg-dark-400 rounded p-1 text-center" placeholder="reps"></div>`).join('')}
                    </div>`;
            },
            renderCharts() {
                if (!AppState.userData.progressHistory) return;
                const commonOptions = (title) => ({ responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: title, color: '#e5e7eb', font: { size: 16 } } }, scales: { x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(156, 163, 175, 0.1)' } }, y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(156, 163, 175, 0.1)' } } } });
                const weightCtx = document.getElementById('weight-chart')?.getContext('2d');
                if (weightCtx) {
                    const weightHistory = AppState.userData.progressHistory.weight || [];
                    if (AppState.charts.weightChart) AppState.charts.weightChart.destroy();
                    AppState.charts.weightChart = new Chart(weightCtx, { type: 'line', data: { labels: weightHistory.map(d => new Date(d.date).toLocaleDateString('pt-PT')), datasets: [{ label: 'Peso (kg)', data: weightHistory.map(d => d.value), borderColor: 'var(--color-primary)', backgroundColor: 'var(--color-primary-hover)', tension: 0.2, fill: false }] }, options: commonOptions('Evolu√ß√£o do Peso (kg)') });
                }
                const volumeCtx = document.getElementById('volume-chart')?.getContext('2d');
                if(volumeCtx) {
                    const volumeHistory = AppState.userData.progressHistory.volume || [];
                    if (AppState.charts.volumeChart) AppState.charts.volumeChart.destroy();
                    AppState.charts.volumeChart = new Chart(volumeCtx, { type: 'bar', data: { labels: volumeHistory.map(d => new Date(d.date).toLocaleDateString('pt-PT')), datasets: [{ label: 'Volume (kg)', data: volumeHistory.map(d => d.value), borderColor: 'var(--color-secondary)', backgroundColor: 'var(--color-secondary)', }] }, options: commonOptions('Volume Total por Sess√£o (kg)') });
                }
            },
            attachWorkoutEventListeners() {
                const container = document.getElementById('workout-plan-container');
                container.addEventListener('input', (event) => {
                    const target = event.target;
                    const exerciseElement = target.closest('[data-exercise-id]');
                    if (exerciseElement && target.type === 'number') Workout.updateLogFromUI(exerciseElement.dataset.dayId, exerciseElement.dataset.exerciseId);
                });
                container.addEventListener('change', (event) => {
                    const target = event.target;
                    const exerciseElement = target.closest('[data-exercise-id]');
                    if (exerciseElement && target.type === 'checkbox') Workout.updateLogFromUI(exerciseElement.dataset.dayId, exerciseElement.dataset.exerciseId);
                });
            },
            getSuggestedWorkoutId() {
                const schedule = { 1: 'A', 2: 'B', 3: 'C', 4: 'D', 5: 'E', 6: 'A', 0: 'B' };
                return schedule[new Date().getDay()];
            },
            toggleAccordion(id) {
                const content = document.getElementById(`content-${id}`);
                const arrow = document.getElementById(`arrow-${id}`);
                if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                    content.style.maxHeight = '0px';
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                    if (arrow) arrow.style.transform = 'rotate(180deg)';
                }
            },
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notif = document.createElement('div');
                const colors = { info: 'bg-blue-600', success: 'bg-green-600', error: 'bg-red-600' };
                notif.className = `p-4 rounded-lg text-white font-semibold shadow-lg transform translate-x-full transition-transform duration-300 ${colors[type]}`;
                notif.textContent = message;
                container.appendChild(notif);
                setTimeout(() => notif.classList.remove('translate-x-full'), 10);
                setTimeout(() => {
                    notif.classList.add('translate-x-full');
                    setTimeout(() => notif.remove(), 300);
                }, 4000);
            },
            switchTab(tabName) {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('tab-active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${tabName}`)?.classList.add('tab-active');
                document.getElementById(`content-${tabName}`)?.classList.remove('hidden');
                if (tabName === 'progresso') this.renderCharts();
            },
            showLoading() { document.getElementById('loading-overlay').classList.add('flex'); document.getElementById('loading-overlay').classList.remove('hidden'); },
            hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('loading-overlay').classList.remove('flex'); },
            showModal(id) { document.getElementById(id).classList.add('flex'); document.getElementById(id).classList.remove('hidden'); },
            closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }
        };

        const Workout = {
            updateLogFromUI(dayId, exerciseId) {
                const day = AppState.userData.workoutPlan.find(d => d.id === dayId);
                const exercise = day?.exercises.find(e => e.id === exerciseId);
                const el = document.querySelector(`[data-day-id="${dayId}"][data-exercise-id="${exerciseId}"]`);
                if (!exercise || !el) return;
                exercise.done = el.querySelector('input[type="checkbox"]').checked;
                const inputs = el.querySelectorAll('input[type="number"]');
                exercise.log = Array.from({ length: inputs.length / 2 }, (_, i) => ({
                    w: parseFloat(inputs[i * 2].value) || 0,
                    r: parseInt(inputs[i * 2 + 1].value) || 0
                }));
            },
            finishWorkout(dayId) {
                UI.showNotification("A guardar o seu progresso...", "info");
                const day = AppState.userData.workoutPlan.find(d => d.id === dayId);
                day.exercises.forEach(ex => this.updateLogFromUI(dayId, ex.id));
                this.checkPersonalRecords(dayId);
                this.updateProgressHistory(dayId);
                Data.saveData().then(() => UI.showNotification(`Treino do dia ${dayId} guardado!`, 'success'));
            },
            saveWeight() {
                const weightInput = document.getElementById('weight-input');
                const newWeight = parseFloat(weightInput.value);
                if (isNaN(newWeight) || newWeight <= 0) {
                    UI.showNotification("Por favor, insira um peso v√°lido.", "error");
                    return;
                }
                const today = new Date().toISOString().split('T')[0];
                const weightHistory = AppState.userData.progressHistory.weight || [];
                const existingIndex = weightHistory.findIndex(entry => entry.date === today);
                if (existingIndex > -1) {
                    weightHistory[existingIndex].value = newWeight;
                } else {
                    weightHistory.push({ date: today, value: newWeight });
                }
                AppState.userData.progressHistory.weight = weightHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
                Data.saveData().then(() => {
                    UI.showNotification("Peso guardado com sucesso!", "success");
                    UI.renderCharts();
                });
            },
            updateProgressHistory(dayId) {
                const today = new Date().toISOString().split('T')[0];
                const day = AppState.userData.workoutPlan.find(d => d.id === dayId);
                const totalVolume = day.exercises.reduce((total, ex) => total + ex.log.reduce((exTotal, set) => exTotal + (set.w * set.r), 0), 0);
                const volumeHistory = AppState.userData.progressHistory.volume || [];
                const existingIndex = volumeHistory.findIndex(v => v.date === today);
                if (existingIndex > -1) {
                    volumeHistory[existingIndex].value = totalVolume;
                } else {
                    volumeHistory.push({ date: today, value: totalVolume });
                }
                AppState.userData.progressHistory.volume = volumeHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
            },
            checkPersonalRecords(dayId) {
                const day = AppState.userData.workoutPlan.find(d => d.id === dayId);
                day.exercises.forEach(exercise => {
                    const currentPR = AppState.userData.personalRecords[exercise.id] || { w: 0, r: 0 };
                    let newPRFound = false;
                    exercise.log.forEach(set => {
                        if (set.w > currentPR.w) {
                            AppState.userData.personalRecords[exercise.id] = { w: set.w, r: set.r };
                            newPRFound = true;
                        }
                    });
                    if (newPRFound) {
                        UI.showNotification(`üèÜ Novo Recorde Pessoal em ${exercise.name}!`, 'success');
                    }
                });
            }
        };

        const AICoach = {
            currentContext: null,
            openModal(context, data = '') {
                this.currentContext = context;
                const titleEl = document.getElementById('gemini-modal-title');
                const contentEl = document.getElementById('gemini-modal-content');
                const responseEl = document.getElementById('gemini-modal-response');
                responseEl.classList.add('hidden');
                
                let title = '', contentHTML = '', btnText = 'Gerar';
                const textArea = (placeholder) => `<textarea id="gemini-input" class="w-full bg-dark-300 text-white rounded-lg p-3 h-28 border-2 border-transparent focus:border-gemini outline-none" placeholder="${placeholder}"></textarea>`;

                switch(context) {
                    case 'generate-plan':
                        title = '‚ú® Gerar Novo Plano de Treino';
                        contentHTML = `<p class="text-gray-400 mb-2">Descreva os seus objetivos, quantos dias por semana pode treinar e qualquer outra prefer√™ncia.</p>${textArea('Ex: Quero focar em hipertrofia, 5 dias por semana, com √™nfase em pernas.')}`;
                        break;
                    case 'generate-diet':
                        title = '‚ú® Gerar Novo Plano Alimentar';
                        contentHTML = `<p class="text-gray-400 mb-2">Descreva os seus objetivos (ex: perder peso, ganhar massa), restri√ß√µes (ex: sem lactose) e comidas preferidas.</p>${textArea('Ex: Objetivo de ganhar massa magra, sem gl√∫ten, gosto de frango e batata doce.')}`;
                        break;
                    case 'analyze-meal':
                        title = 'ü•ó Analisar Refei√ß√£o';
                        contentHTML = `<p class="text-gray-400 mb-2">Descreva os alimentos e quantidades da sua refei√ß√£o para receber uma an√°lise nutricional.</p>${textArea('Ex: 150g de salm√£o, 100g de arroz branco e uma salada de alface com tomate.')}`;
                        btnText = 'Analisar';
                        break;
                    case 'weekly-summary':
                        title = 'üìä Resumo da Semana com IA';
                        contentHTML = `<p class="text-gray-400 mb-2">A IA ir√° analisar o seu progresso de volume e recordes da √∫ltima semana para lhe dar um feedback motivacional.</p>`;
                        btnText = 'Analisar Semana';
                        break;
                    case 'substitute':
                        title = `üîÑ Substituir ${data}`;
                        contentHTML = `<p class="text-gray-400 mb-2">A IA ir√° sugerir 3 alternativas para <strong>${data}</strong>. Pode adicionar mais detalhes (ex: equipamento indispon√≠vel, dor no ombro).</p>${textArea('Ex: O aparelho est√° ocupado.')}`;
                        btnText = 'Sugerir';
                        break;
                    case 'technique':
                        title = `üí° Dicas de T√©cnica para ${data}`;
                        contentHTML = `<p class="text-gray-400 mb-2">A IA ir√° gerar dicas de execu√ß√£o e erros comuns para <strong>${data}</strong>.</p>`;
                        btnText = 'Obter Dicas';
                        break;
                }
                titleEl.textContent = title;
                contentEl.innerHTML = contentHTML;
                document.getElementById('gemini-btn-text').textContent = btnText;
                document.getElementById('gemini-modal-action-btn').onclick = () => this.processRequest(data);
                UI.showModal('gemini-modal');
            },
            async processRequest(data) {
                const inputEl = document.getElementById('gemini-input');
                const userInput = inputEl ? inputEl.value : '';
                let prompt = '';

                switch(this.currentContext) {
                    case 'generate-plan':
                        prompt = `Aja como um personal trainer especialista. Crie um plano de treino de muscula√ß√£o com base no seguinte pedido do utilizador: "${userInput}". O plano deve ser estruturado e realista. Responda APENAS com um objeto JSON v√°lido, sem qualquer texto ou formata√ß√£o extra. O JSON deve seguir este schema: { "workoutPlan": [{ "id": "A", "name": "Nome do Treino", "focus": "M√∫sculos Focados", "exercises": [{ "id": "ex_unico_1", "name": "Nome do Exerc√≠cio", "sets": 4, "reps": "8-12" }] }] }. Garanta que os "id" dos exerc√≠cios sejam √∫nicos (ex: ex1, ex2, etc.).`;
                        break;
                    case 'generate-diet':
                         prompt = `Aja como um nutricionista desportivo. Crie um plano alimentar com base no seguinte pedido do utilizador: "${userInput}". O plano deve ser estruturado e realista, com 5 a 6 refei√ß√µes. Responda APENAS com um objeto JSON v√°lido, sem qualquer texto ou formata√ß√£o extra. O JSON deve seguir este schema: { "dietPlan": [{ "id": "meal1", "name": "Pequeno-Almo√ßo", "time": "08:00", "items": ["Item 1", "Item 2"] }] }.`;
                        break;
                    case 'analyze-meal':
                        prompt = `Aja como um nutricionista. Analise a seguinte refei√ß√£o descrita pelo utilizador: "${userInput}". Forne√ßa uma estimativa de calorias, prote√≠nas, carboidratos e gorduras. D√™ tamb√©m uma breve opini√£o sobre a qualidade da refei√ß√£o e uma sugest√£o de melhoria, se aplic√°vel.`;
                        break;
                    case 'weekly-summary':
                        const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                        const weeklyVolume = AppState.userData.progressHistory.volume.filter(v => v.date >= oneWeekAgo);
                        prompt = `Aja como um coach de fitness motivacional. Analise os dados de progresso da √∫ltima semana do utilizador: ${JSON.stringify(weeklyVolume)}. Forne√ßa um resumo conciso e motivador. Destaque uma vit√≥ria (ex: consist√™ncia, aumento de volume) e sugira um pequeno foco para a pr√≥xima semana. Mantenha o tom positivo e encorajador.`;
                        break;
                    case 'substitute':
                        prompt = `Aja como um personal trainer. Sugira 3 exerc√≠cios alternativos para "${data}". O utilizador adicionou o seguinte contexto: "${userInput}". Para cada alternativa, explique brevemente o porqu√™ da sugest√£o.`;
                        break;
                    case 'technique':
                        prompt = `Aja como um personal trainer. Forne√ßa dicas de t√©cnica detalhadas para o exerc√≠cio "${data}". Organize a resposta em "Execu√ß√£o Passo a Passo" e "Erros Comuns a Evitar".`;
                        break;
                }
                
                const isJson = this.currentContext === 'generate-plan' || this.currentContext === 'generate-diet';
                const responseText = await Gemini.generate(prompt, isJson);
                
                if (isJson && responseText) {
                    try {
                        const parsed = JSON.parse(responseText);
                        if (parsed.workoutPlan) {
                            const createLogs = (count) => Array.from({ length: count }, () => ({ w: 0, r: 0 }));
                            parsed.workoutPlan.forEach(day => day.exercises.forEach(ex => { ex.done = false; ex.log = createLogs(ex.sets); }));
                            AppState.userData.workoutPlan = parsed.workoutPlan;
                            UI.showNotification("Novo plano de treino gerado e guardado!", "success");
                            UI.renderWorkoutPlan();
                        } else if (parsed.dietPlan) {
                            AppState.userData.dietPlan = parsed.dietPlan;
                            UI.showNotification("Novo plano alimentar gerado e guardado!", "success");
                            UI.renderDietPlan();
                        } else { throw new Error("JSON com formato inesperado."); }
                        
                        await Data.saveData();
                        UI.closeModal('gemini-modal');

                    } catch (e) {
                        console.error("JSON Parsing Error:", e);
                        UI.showNotification("Erro ao processar a resposta da IA.", "error");
                    }
                } else if (responseText) {
                    const responseEl = document.getElementById('gemini-modal-response');
                    document.getElementById('gemini-response-text').textContent = responseText;
                    responseEl.classList.remove('hidden');
                }
            }
        };

        const Gemini = {
            async generate(prompt, isJson = false) {
                const btnText = document.getElementById('gemini-btn-text');
                const btnLoading = document.getElementById('gemini-btn-loading');
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                };

                if (isJson) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                    };
                }

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.statusText} - ${errorBody.error.message}`);
                    }
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                        throw new Error("Resposta da API inv√°lida.");
                    }
                    return result.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    UI.showNotification("Erro ao comunicar com a IA.", "error");
                    return null;
                } finally {
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                }
            }
        };
        
        const sessionTimer = {
            interval: null, startTime: null, elapsedTime: 0,
            start() { if (this.interval) return; this.startTime = Date.now() - this.elapsedTime; this.interval = setInterval(this.update.bind(this), 1000); },
            pause() { if (!this.interval) return; clearInterval(this.interval); this.interval = null; this.elapsedTime = Date.now() - this.startTime; },
            reset() { if (this.interval) clearInterval(this.interval); this.interval = null; this.startTime = null; this.elapsedTime = 0; document.getElementById('session-timer').textContent = '00:00:00'; },
            update() {
                const elapsed = Date.now() - this.startTime;
                const h = Math.floor(elapsed / 3600000).toString().padStart(2, '0');
                const m = Math.floor((elapsed % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((elapsed % 60000) / 1000).toString().padStart(2, '0');
                document.getElementById('session-timer').textContent = `${h}:${m}:${s}`;
            }
        };

        window.UI = UI;
        window.Workout = Workout;
        window.AICoach = AICoach;
        window.sessionTimer = sessionTimer;

        document.addEventListener('DOMContentLoaded', () => {
            UI.showLoading();
            Data.init();
        });
    </script>
</body>
</html>
